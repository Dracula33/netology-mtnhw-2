_[Ссылка](https://github.com/netology-code/mnt-homeworks/tree/MNT-13/08-ansible-04-role) на задание_

---

### Описание Playbook

Play по добавлению данных в /etc/hosts
1. Плей выполняется на хостах групп `clickhouse`, `vector`, `lighthouse`
2. В единственной таске вызывается модуль `blockinfile`, который добавляет в /etc/host полученные ip хостов clickhouse-01, vector-01, lighthouse-01 для взаимодействия между ними.
3. В качестве маркера для контроля изменений используется строка `# {mark} ANSIBLE ADD HOSTS`
4. Плей содержит тег `always`, выполняется всегда, когда вызывается выполнение плейбука с каким-либо тегом.

Play по установке Clickhouse
1. В параметрах роли задаем переменную `clickhouse_listen_host`, чтобы разрешить подключение к БД по всем интерфейсам .
2. Также в переменных роли задаем `clickhouse_networks_default`, чтобы пользователи могли подключаться к БД из любых сетей
3. Плей выполняется на хостах группы `clickhouse`
4. Выполняется роль [clickhouse](git@github.com:AlexeySetevoi/ansible-clickhouse.git) версии 1.11.0
5. После роли выполняются post_tasks по созданию объектов в БД
6. Модуль `command` вызывает утилиту `clickhouse-client` с командой по созданию базы данных `logs`. Результат выполнения команды записывается в переменную `create_db`
7. Задача считается `failed`, если код выполнения команды не равен успешному (0), либо означающему, что БД уже создана(82)
8. Задача считается `changed`, если код выполнения успешный (0)
9. Далее при помощи модуля `command` вызывается `clickhouse-client` для создания таблицы `test_table` в БД `logs` с тремя полями типа String (message, source_type, timestamp) и движком `Log`. Результат записывается в переменную `create_db`
10. Задача считается `failed`, если код выполнения команды не успешный (0), либо не означающий, что такая таблица уже существует (57).
11. Задача `changed`, когда код выполнения равен 0
12. Плей содержит тег `clickhouse` для возможности отдельного выполнения

Play по установке Vector
1. В параметрах роли задаем переменные `vector_install_dir`, чтобы установить vector в конкретный каталог
2. Также задаем `data_dir` и `config` для создания настроечного файла Vector
3. Плей выполняется на хостах группы `vector`
4. Выполняется созданная нами роль [vector](https://github.com/Dracula33/ansible-vector) версии 0.0.3
5. Плей содержит тег `vector` для возможности отдельного выполнения

Play по установке Lighthouse
1. В параметрах роли задаем переменную `lighthouse_install_directory`, чтобы установить Lighthouse в конкретный каталог
2. Плей выполняется на хостах группы `lighthouse`
3. На уровне плея есть `handler`, который перезапускает процесс `nginx` через `systemctl` с перечитыванием измененных конфигурационных файлов
4. Роль содержит pre_tasks по установке nginx
5. В первой pre_task вызывается модуль `yum`. При помощи `with_items` уставливаются пакеты `epel-release` и `nginx`. Вызывается `handler`
6. При помощи `templates` создается настроечный файл `/etc/nginx/conf.d/lighthouse.conf`, который по 80 порту и URI `/lighthouse` возвращает файл index.html из каталога с lighthouse
7. Выполняется созданная нами роль [lighthouse](https://github.com/Dracula33/ansible-lighthouse) версии 0.0.2
8. Плей содержит тег `lighthouse` для возможности отдельного выполнения

